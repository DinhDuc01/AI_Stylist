<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>AI Ph·ªëi ƒê·ªì - LookAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tr·ª£ l√Ω AI ph·ªëi ƒë·ªì th√¥ng minh - Nh·∫≠n g·ª£i √Ω trang ph·ª•c c√° nh√¢n h√≥a" />
    <meta name="keywords" content="AI Stylist, Ph·ªëi ƒë·ªì, G·ª£i √Ω trang ph·ª•c, Chatbot th·ªùi trang" />
    <meta name="author" content="LookAI" />
    <link rel="shortcut icon" href="../assets/images/favicon.ico.png">
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/remixicon.css" rel="stylesheet" type="text/css" />
    <link href="https://unicons.iconscout.com/release/v3.0.6/css/line.css" rel="stylesheet">
    <link href="../assets/css/style.min.css" rel="stylesheet" type="text/css" id="theme-opt" />
    <style>
        .chat-container {
            height: 600px;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            background: #fff;
        }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .chat-messages {
            height: 450px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.bot {
            justify-content: flex-start;
        }
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }
        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .message.user .message-avatar {
            background: #007bff;
            color: white;
        }
        .message.bot .message-avatar {
            background: #6c757d;
            color: white;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        .outfit-suggestion {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }
        .outfit-item {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #dee2e6;
        }
        .quick-actions {
            margin-bottom: 20px;
        }
        .quick-action-btn {
            margin: 5px;
            border-radius: 20px;
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            background: #6c757d;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>

<body>
    <div id="preloader">
        <div id="status">
            <div class="spinner">
                <div class="double-bounce1"></div>
                <div class="double-bounce2"></div>
            </div>
        </div>
    </div>

    <header id="topnav" class="navigation sticky">
        <div class="container">
            <div>
                <a class="logo" href="index.html">
                    <span class="logo-light-mode">
                        <img src="../assets/images/LookAILogo.png" class="l-dark" height="80" alt="LookAI Logo">
                        <img src="../assets/images/LookAILogo.png" class="l-light" height="80" alt="LookAI Logo">
                    </span>
                </a>
            </div>

            <div id="navigation">
                <ul class="navigation-menu">
                    <li><a href="index.html" class="sub-menu-item">Trang ch·ªß</a></li>
                    <li><a href="ai-stylist.html" class="sub-menu-item">AI Ph·ªëi ƒë·ªì</a></li>
                    <li><a href="wardrobe.html" class="sub-menu-item">T·ªß ƒë·ªì s·ªë</a></li>
                    <li><a href="virtual-fitting.html" class="sub-menu-item">Th·ª≠ ƒë·ªì ·∫£o</a></li>
                    <li><a href="departments.html" class="sub-menu-item">Lookbook</a></li>
                    <li class="active"><a href="aboutus.html" class="sub-menu-item">V·ªÅ ch√∫ng t√¥i</a></li>
                </ul>
            </div>
            
            <div class="menu-extras">
                <div class="menu-item">
                    <a class="navbar-toggle" id="isToggle" onclick="toggleMenu()">
                        <div class="lines">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <section class="bg-half-170 d-table w-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="bg-overlay bg-overlay-dark"></div>
        <div class="container">
            <div class="row mt-5 justify-content-center">
                <div class="col-12">
                    <div class="heading-title text-center">
                        <i class="ri-robot-fill text-white display-4 mb-3"></i>
                        <h2 class="text-white title-dark mb-3">AI Ph·ªëi ƒê·ªì Th√¥ng Minh</h2>
                        <p class="text-white-50 para-desc mx-auto mb-0">Tr√≤ chuy·ªán v·ªõi AI ƒë·ªÉ nh·∫≠n g·ª£i √Ω trang ph·ª•c ph√π h·ª£p v·ªõi m·ªçi ho√†n c·∫£nh</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card border-0 shadow rounded">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="ri-flashlight-line text-primary me-2"></i>
                                G·ª£i √ù Nhanh
                            </h5>
                            <div class="quick-actions text-center">
                                <button class="btn btn-outline-primary quick-action-btn" onclick="sendQuickMessage('G·ª£i √Ω trang ph·ª•c ƒëi l√†m h√¥m nay')">
                                    <i class="ri-briefcase-line me-1"></i>ƒêi l√†m
                                </button>
                                <button class="btn btn-outline-success quick-action-btn" onclick="sendQuickMessage('Trang ph·ª•c d·∫°o ph·ªë cu·ªëi tu·∫ßn')">
                                    <i class="ri-walk-line me-1"></i>D·∫°o ph·ªë
                                </button>
                                <button class="btn btn-outline-warning quick-action-btn" onclick="sendQuickMessage('Ph·ªëi ƒë·ªì cho bu·ªïi h·∫πn h√≤')">
                                    <i class="ri-heart-line me-1"></i>H·∫πn h√≤
                                </button>
                                <button class="btn btn-outline-info quick-action-btn" onclick="sendQuickMessage('Trang ph·ª•c t·∫≠p th·ªÉ thao')">
                                    <i class="ri-run-line me-1"></i>Th·ªÉ thao
                                </button>
                                <button class="btn btn-outline-danger quick-action-btn" onclick="sendQuickMessage('ƒê·ªì d·ª± ti·ªác t·ªëi')">
                                    <i class="ri-goblet-line me-1"></i>Ti·ªác t·ªëi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8 mx-auto">
                    <div class="chat-container shadow">
                        <div class="chat-header">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="me-3">
                                    <i class="ri-robot-fill display-6"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">LookAI Stylist</h5>
                                    <small class="opacity-75">Tr·ª£ l√Ω th·ªùi trang AI c·ªßa b·∫°n</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div class="message bot">
                                <div class="message-avatar">
                                    <i class="ri-robot-line"></i>
                                </div>
                                <div class="message-content">
                                    <p class="mb-2">Xin ch√†o! T√¥i l√† LookAI, tr·ª£ l√Ω th·ªùi trang AI c·ªßa b·∫°n. üëã</p>
                                    <p class="mb-0">H√£y cho t√¥i bi·∫øt b·∫°n c·∫ßn g·ª£i √Ω trang ph·ª•c cho ho√†n c·∫£nh n√†o nh√©!</p>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input">
                            <div class="input-group">
                                <input type="text" class="form-control" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." onkeypress="handleKeyPress(event)">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                    <i class="ri-send-plane-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 mt-4">
                    <div class="card border-0 shadow rounded">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <i class="ri-lightbulb-line text-primary me-2"></i>
                                G·ª£i √ù Ph·ªëi ƒê·ªì M·ªõi Nh·∫•t
                            </h5>
                            <div class="row" id="outfitSuggestions">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-footer">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="footer-py-60 text-center">
                        <p class="mb-0 text-muted">¬© 2024 LookAI. Thi·∫øt k·∫ø b·ªüi <a href="#" target="_blank" class="text-reset">LookAI Team</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <a href="#" onclick="topFunction()" id="back-to-top" class="back-to-top fs-5"><i data-feather="arrow-up" class="fea icon-sm icons align-middle"></i></a>

    <script src="../assets/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/feather.min.js"></script>
    <script src="../assets/js/app.js"></script>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        
        // Weather AI Integration
        const WEATHER_API_KEY = 'd1ca006774aa4d9491d21940250611'; // WeatherAPI.com
        const GEMINI_API_KEY = 'AIzaSyBYgj63cniNH6OyRmGifLNo7peqgU_L6k8'; // Google Gemini API
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        
        // Kh·ªüi t·∫°o Weather AI
        let weatherAI = null;
        
        // Page navigation mapping
        const PAGE_LINKS = {
            'trang ch·ªß': 'index.html',
            'home': 'index.html',
            't·ªß ƒë·ªì': 'wardrobe.html',
            'wardrobe': 'wardrobe.html',
            'qu·∫£n l√Ω t·ªß ƒë·ªì': 'wardrobe.html',
            'th·ª≠ ƒë·ªì': 'virtual-fitting.html',
            'virtual fitting': 'virtual-fitting.html',
            'th·ª≠ ƒë·ªì ·∫£o': 'virtual-fitting.html',
            'ar': 'virtual-fitting.html',
            'lookbook': 'departments.html',
            'b·ªô s∆∞u t·∫≠p': 'departments.html',
            'v·ªÅ ch√∫ng t√¥i': 'aboutus.html',
            'about': 'aboutus.html',
            'li√™n h·ªá': 'contact.html',
            'contact': 'contact.html'
        };

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u 3 outfit m·ªõi nh·∫•t
        let latestOutfitsCache = [];
        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·∫°ng th√°i y√™u th√≠ch
        let favoritedHashesCache = new Set();

        function addMessage(content, isUser = false, outfit = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            let messageHTML = `
                <div class="message-avatar">
                    <i class="${isUser ? 'ri-user-line' : 'ri-robot-line'}"></i>
                </div>
                <div class="message-content">
                    <p class="mb-0">${content}</p>
            `;

            if (outfit) {
                messageHTML += `
                    <div class="outfit-suggestion mt-3">
                        <h6 class="mb-2">
                            <i class="${outfit.icon} text-primary me-2"></i>
                            ${outfit.title}
                        </h6>
                        <div class="mb-2">
                            ${outfit.items.map(item => `<span class="outfit-item">${item}</span>`).join('')}
                        </div>
                        <small class="text-muted">
                            <i class="ri-thermometer-line me-1"></i>Ph√π h·ª£p: ${outfit.weather}
                        </small>
                    </div>
                `;
            }

            messageHTML += '</div>';
            messageDiv.innerHTML = messageHTML;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="ri-robot-line"></i>
                </div>
                <div class="message-content">
                    <div class="typing-indicator" style="display: block;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            const typingIndicator = showTypingIndicator();

            try {
                // Ki·ªÉm tra xem c√≥ y√™u c·∫ßu ƒëi·ªÅu h∆∞·ªõng kh√¥ng
                const navigationResult = checkForNavigation(message);
                if (navigationResult) {
                    typingIndicator.remove();
                    addMessage(navigationResult.message, false);
                    // Ch·ªù 2 gi√¢y r·ªìi chuy·ªÉn trang
                    setTimeout(() => {
                        window.location.href = navigationResult.url;
                    }, 2000);
                    return;
                }

                // G·ª≠i tin nh·∫Øn ƒë·∫øn Gemini AI
                const aiResponse = await callGeminiAPI(message);
                typingIndicator.remove();
                
                // X·ª≠ l√Ω ph·∫£n h·ªìi v√† t·∫°o outfit n·∫øu c·∫ßn
                const processedResponse = processAIResponse(aiResponse, message);
                addMessage(processedResponse.message, false, processedResponse.outfit);

            } catch (error) {
                console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
                typingIndicator.remove();
                addMessage('√îi, c√≥ l·ªói x·∫£y ra r·ªìi. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i!', false);
            }
        }

        function sendQuickMessage(message) {
            messageInput.value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // ---
        // --- C·∫¨P NH·∫¨T PH·∫¶N G·ª¢I √ù M·ªöI NH·∫§T ---
        // ---
        
        /**
         * 1. T·∫£i 3 g·ª£i √Ω outfit m·ªõi nh·∫•t
         */
        async function loadLatestOutfits() {
            const suggestionsContainer = document.getElementById('outfitSuggestions');
            suggestionsContainer.innerHTML = '<p class="text-center text-muted col-12">ƒêang t·∫£i g·ª£i √Ω m·ªõi nh·∫•t...</p>';

            try {
                // 1.1. L·∫•y 3 outfit m·ªõi nh·∫•t
                const response = await fetch(`${API_BASE_URL}/api/chat/latest-outfits`);
                const data = await response.json();

                if (!data.success || !data.outfits || data.outfits.length === 0) {
                    suggestionsContainer.innerHTML = '<p class="text-center text-muted col-12">Ch∆∞a c√≥ g·ª£i √Ω n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                    return;
                }

                latestOutfitsCache = data.outfits; // L∆∞u v√†o cache
                
                // 1.2. T·∫°o hash v√† ki·ªÉm tra tr·∫°ng th√°i y√™u th√≠ch
                const hashes = latestOutfitsCache.map(outfit => outfit.title + outfit.items.join(','));
                
                const statusResponse = await fetch(`${API_BASE_URL}/api/lookbook/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hashes: hashes })
                });
                const statusData = await statusResponse.json();
                
                if (statusData.success) {
                    favoritedHashesCache = new Set(statusData.favoritedHashes);
                }

                // 1.3. Hi·ªÉn th·ªã ra HTML
                suggestionsContainer.innerHTML = ''; // X√≥a loading
                latestOutfitsCache.forEach((outfit, index) => {
                    const outfitHash = hashes[index];
                    const isFavorited = favoritedHashesCache.has(outfitHash);
                    
                    const icon = isFavorited ? 'ri-heart-fill' : 'ri-heart-line';
                    const btnClass = isFavorited ? 'btn-primary' : 'btn-outline-primary';

                    const outfitHtml = `
                        <div class="col-md-4 mb-4">
                            <div class="outfit-suggestion">
                                <h6 class="mb-3">
                                    <i class="${outfit.icon || 'ri-lightbulb-flash-line'} text-primary me-2"></i>
                                    ${outfit.title}
                                </h6>
                                <div class="mb-3">
                                    ${outfit.items.map(item => `<span class="outfit-item">${item}</span>`).join('')}
                                </div>
                                <small class="text-muted">
                                    <i class="ri-thermometer-line me-1"></i>Ph√π h·ª£p: ${outfit.weather}
                                </small>
                                <div class="mt-2">
                                    <button class="btn btn-sm ${btnClass}" id="fav-btn-${index}" onclick="toggleFavorite(this, ${index})">
                                        <i class="${icon} me-1"></i>Y√™u th√≠ch
                                    </button>
                                    <button class="btn btn-sm btn-outline-success">
                                        <i class="ri-share-line me-1"></i>Chia s·∫ª
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    suggestionsContainer.innerHTML += outfitHtml;
                });

            } catch (error) {
                console.error('L·ªói khi t·∫£i g·ª£i √Ω m·ªõi nh·∫•t:', error);
                suggestionsContainer.innerHTML = '<p class="text-center text-danger col-12">Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω.</p>';
            }
        }

        /**
         * 2. TH√äM M·ªöI: H√†m Toggle Y√™u th√≠ch
         */
        async function toggleFavorite(buttonElement, index) {
            const outfit = latestOutfitsCache[index];
            if (!outfit) return;

            // V√¥ hi·ªáu h√≥a n√∫t
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/lookbook/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ outfit: outfit })
                });

                const data = await response.json();

                if (data.success) {
                    // C·∫≠p nh·∫≠t giao di·ªán n√∫t
                    if (data.favorited) {
                        buttonElement.classList.remove('btn-outline-primary');
                        buttonElement.classList.add('btn-primary');
                        buttonElement.innerHTML = '<i class="ri-heart-fill me-1"></i>Y√™u th√≠ch';
                    } else {
                        buttonElement.classList.remove('btn-primary');
                        buttonElement.classList.add('btn-outline-primary');
                        buttonElement.innerHTML = '<i class="ri-heart-line me-1"></i>Y√™u th√≠ch';
                    }
                }
            } catch (error) {
                console.error('L·ªói khi toggle y√™u th√≠ch:', error);
                buttonElement.innerHTML = 'L·ªói';
            } finally {
                // K√≠ch ho·∫°t l·∫°i n√∫t
                buttonElement.disabled = false;
            }
        }

        /**
         * Ki·ªÉm tra y√™u c·∫ßu ƒëi·ªÅu h∆∞·ªõng trong tin nh·∫Øn
         */
        function checkForNavigation(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [keyword, url] of Object.entries(PAGE_LINKS)) {
                if (lowerMessage.includes(keyword)) {
                    return {
                        message: `ƒêang chuy·ªÉn b·∫°n ƒë·∫øn trang ${keyword}... üöÄ`,
                        url: url
                    };
                }
            }
            return null;
        }

        /**
         * G·ª≠i request ƒë·∫øn Weather AI (s·ª≠ d·ª•ng th·ªùi ti·∫øt th·∫≠t)
         */
        async function callGeminiAPI(userMessage) {
            // Ki·ªÉm tra n·∫øu weatherAI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o
            if (!weatherAI) {
                console.error('WeatherAI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
                return await callOriginalGeminiAPI(userMessage);
            }

            try {
                // L·∫•y th·ªùi ti·∫øt th·∫≠t tr∆∞·ªõc
                const weather = await weatherAI.getRealWeather('Hanoi');
                
                // X√°c ƒë·ªãnh ho·∫°t ƒë·ªông t·ª´ tin nh·∫Øn
                const activity = detectActivity(userMessage);
                
                // L·∫•y g·ª£i √Ω AI d·ª±a tr√™n th·ªùi ti·∫øt th·∫≠t
                const suggestion = await weatherAI.getAIOutfitSuggestion(weather, activity);
                
                // T·∫°o ph·∫£n h·ªìi t·ªïng h·ª£p
                let response = `D·ª±a tr√™n th·ªùi ti·∫øt hi·ªán t·∫°i ·ªü ${weather.location} (${weather.temperature}¬∞C, ${weather.condition}), t√¥i g·ª£i √Ω:\n\n`;
                
                if (typeof suggestion === 'object' && suggestion.top) {
                    response += `üëï **√Åo:** ${suggestion.top}\n`;
                    response += `üëñ **Qu·∫ßn/V√°y:** ${suggestion.bottom}\n`;
                    response += `üë† **Gi√†y:** ${suggestion.shoes}\n`;
                    if (suggestion.accessories && suggestion.accessories.length > 0) {
                        response += `üéí **Ph·ª• ki·ªán:** ${suggestion.accessories.join(', ')}\n`;
                    }
                    response += `\nüí° **L√Ω do:** ${suggestion.reason}`;
                } else {
                    response += suggestion;
                }
                
                return response;
                
            } catch (error) {
                console.error('L·ªói Weather AI:', error);
                // Fallback v·ªÅ Gemini th√¥ng th∆∞·ªùng
                return await callOriginalGeminiAPI(userMessage);
            }
        }
        
        /**
         * Gemini API g·ªëc (fallback)
         */
        async function callOriginalGeminiAPI(userMessage) {
            try {
                const prompt = createFashionPrompt(userMessage);
                
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 500
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    throw new Error(`Gemini API l·ªói: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Gemini API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
                }
                
                return data.candidates[0].content.parts[0].text;
                
            } catch (error) {
                console.error('L·ªói g·ªçi Gemini API:', error);
                // Tr·∫£ v·ªÅ ph·∫£n h·ªìi m·∫∑c ƒë·ªãnh
                return 'Xin l·ªói, t√¥i ƒëang g·∫∑p s·ª± c·ªë k·ªπ thu·∫≠t. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t! üòî \n\nTrong l√∫c ch·ªù, b·∫°n c√≥ th·ªÉ th·ª≠ c√°c g·ª£i √Ω nhanh b√™n tr√™n nh√©!';
            }
        }
        
        /**
         * Ph√°t hi·ªán ho·∫°t ƒë·ªông t·ª´ tin nh·∫Øn
         */
        function detectActivity(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('ƒëi l√†m') || lowerMessage.includes('c√¥ng s·ªü')) return 'work';
            if (lowerMessage.includes('h·∫πn h√≤') || lowerMessage.includes('date')) return 'date';
            if (lowerMessage.includes('th·ªÉ thao') || lowerMessage.includes('gym')) return 'sport';
            if (lowerMessage.includes('ti·ªác') || lowerMessage.includes('party')) return 'party';
            if (lowerMessage.includes('d·∫°o ph·ªë') || lowerMessage.includes('cu·ªëi tu·∫ßn')) return 'casual';
            
            return 'casual';
        }

        /**
         * T·∫°o prompt chuy√™n v·ªÅ th·ªùi trang cho Gemini (fallback)
         */
        function createFashionPrompt(userMessage) {
            const currentWeather = weatherAI ? weatherAI.getCurrentWeatherInfo() : 'Kh√¥ng c√≥ th√¥ng tin th·ªùi ti·∫øt';
            
            return `B·∫°n l√† chuy√™n gia th·ªùi trang AI t√™n LookAI. Ch·ªâ tr·∫£ l·ªùi v·ªÅ ch·ªß ƒë·ªÅ th·ªùi trang, qu·∫ßn √°o, ph·ªëi ƒë·ªì, v√† th·ªùi ti·∫øt.

Th√¥ng tin th·ªùi ti·∫øt hi·ªán t·∫°i: ${currentWeather}

C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng: ${userMessage}

H∆∞·ªõng d·∫´n:
- Ch·ªâ tr·∫£ l·ªùi v·ªÅ th·ªùi trang, qu·∫ßn √°o, ph·ªëi ƒë·ªì
- ƒê∆∞a ra g·ª£i √Ω c·ª• th·ªÉ v·ªÅ trang ph·ª•c
- Xem x√©t th·ªùi ti·∫øt khi ƒë∆∞a g·ª£i √Ω
- N·∫øu h·ªèi v·ªÅ ch·ªß ƒë·ªÅ kh√°c, l·ªãch s·ª± tr·∫£ l·ªùi: "T√¥i ch·ªâ c√≥ th·ªÉ gi√∫p b·∫°n v·ªÅ th·ªùi trang v√† qu·∫ßn √°o th√¥i nh√©!"
- Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, th√¢n thi·ªán v√† nhi·ªát t√¨nh
- N·∫øu c√≥ th·ªÉ, ƒë∆∞a ra 3-5 m√≥n ƒë·ªì c·ª• th·ªÉ

Tr·∫£ l·ªùi:`;
        }

        // ===== WEATHER AI CLASS =====
        class WeatherOutfitAI {
            constructor() {
                this.weatherApiKey = WEATHER_API_KEY;
                this.geminiApiKey = GEMINI_API_KEY;
                this.personalWardrobe = this.loadWardrobe();
                this.weatherCache = new Map();
                this.cacheTimeout = 10 * 60 * 1000; // 10 ph√∫t
                this.lastWeather = null;
            }

            async getRealWeather(city = 'Hanoi') {
                const cacheKey = `weather_${city}`;
                const cached = this.weatherCache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await fetch(
                        `https://api.weatherapi.com/v1/current.json?key=${this.weatherApiKey}&q=${city}&lang=vi`
                    );
                    
                    if (!response.ok) throw new Error('Weather API error');
                    
                    const data = await response.json();
                    const weatherData = {
                        temperature: data.current.temp_c,
                        condition: data.current.condition.text,
                        humidity: data.current.humidity,
                        windSpeed: data.current.wind_kph,
                        feelsLike: data.current.feelslike_c,
                        uvIndex: data.current.uv,
                        visibility: data.current.vis_km,
                        icon: data.current.condition.icon,
                        isDay: data.current.is_day,
                        location: `${data.location.name}, ${data.location.country}`
                    };
                    
                    this.weatherCache.set(cacheKey, {
                        data: weatherData,
                        timestamp: Date.now()
                    });
                    
                    this.lastWeather = weatherData;
                    return weatherData;
                    
                } catch (error) {
                    console.error('L·ªói l·∫•y th·ªùi ti·∫øt:', error);
                    return this.getFallbackWeather();
                }
            }

            async getAIOutfitSuggestion(weather, activity = 'work', userPreferences = {}) {
                try {
                    const prompt = this.buildOutfitPrompt(weather, activity, userPreferences);
                    
                    const response = await fetch(`${GEMINI_API_URL}?key=${this.geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `B·∫°n l√† chuy√™n gia th·ªùi trang AI. ${prompt}` }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 500
                            }
                        })
                    });

                    if (!response.ok) throw new Error('Gemini API error');

                    const aiResponse = await response.json();
                    const suggestion = aiResponse.candidates[0].content.parts[0].text;
                    
                    return this.parseAISuggestion(suggestion, weather);
                    
                } catch (error) {
                    console.error('L·ªói Gemini AI:', error);
                    return this.getRuleBasedSuggestion(weather, activity);
                }
            }

            buildOutfitPrompt(weather, activity, preferences) {
                const wardrobeItems = this.getAvailableClothes();
                
                return `
Th·ªùi ti·∫øt hi·ªán t·∫°i:
- Nhi·ªát ƒë·ªô: ${weather.temperature}¬∞C (c·∫£m gi√°c nh∆∞ ${weather.feelsLike}¬∞C)
- Th·ªùi ti·∫øt: ${weather.condition}
- ƒê·ªô ·∫©m: ${weather.humidity}%
- Gi√≥: ${weather.windSpeed} km/h

Ho·∫°t ƒë·ªông: ${activity}

T·ªß ƒë·ªì c√≥ s·∫µn:
${wardrobeItems}

H√£y g·ª£i √Ω outfit c·ª• th·ªÉ t·ª´ t·ªß ƒë·ªì c√≥ s·∫µn, bao g·ªìm:
1. √Åo (lo·∫°i, m√†u, ch·∫•t li·ªáu)
2. Qu·∫ßn/V√°y (lo·∫°i, m√†u)
3. Gi√†y d√©p
4. Ph·ª• ki·ªán (n·∫øu c·∫ßn)
5. L√Ω do t·∫°i sao ph√π h·ª£p

Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, th√¢n thi·ªán v√† c·ª• th·ªÉ.`;
            }

            getRuleBasedSuggestion(weather, activity) {
                const temp = weather.temperature;
                const isRaining = weather.condition.toLowerCase().includes('m∆∞a');
                const isWindy = weather.windSpeed > 15;
                
                let suggestion = {
                    top: '',
                    bottom: '',
                    shoes: '',
                    accessories: [],
                    reason: '',
                    comfort_score: 8
                };

                if (temp < 15) {
                    suggestion.top = '√Åo kho√°c d√†y, √°o len c·ªï l·ªç';
                    suggestion.bottom = 'Qu·∫ßn jeans d√†y ho·∫∑c qu·∫ßn t√¢y';
                    suggestion.shoes = 'Gi√†y b·ªët cao c·ªï';
                    suggestion.accessories = ['KhƒÉn qu√†ng c·ªï', 'M≈© len'];
                    suggestion.reason = 'Th·ªùi ti·∫øt l·∫°nh, c·∫ßn gi·ªØ ·∫•m to√†n th√¢n';
                } else if (temp < 25) {
                    suggestion.top = '√Åo s∆° mi ho·∫∑c √°o thun d√†i tay';
                    suggestion.bottom = 'Qu·∫ßn √¢u ho·∫∑c ch√¢n v√°y';
                    suggestion.shoes = 'Gi√†y da ho·∫∑c sneaker';
                    suggestion.accessories = [];
                    suggestion.reason = 'Th·ªùi ti·∫øt d·ªÖ ch·ªãu, tho·∫£i m√°i v·ªõi trang ph·ª•c nh·∫π';
                } else {
                    suggestion.top = '√Åo thun cotton ho·∫∑c √°o tank top';
                    suggestion.bottom = 'Qu·∫ßn short ho·∫∑c v√°y ng·∫Øn';
                    suggestion.shoes = 'Sandal ho·∫∑c gi√†y th·ªÉ thao tho√°ng kh√≠';
                    suggestion.accessories = ['M≈© ch·ªëng n·∫Øng', 'K√≠nh r√¢m'];
                    suggestion.reason = 'Th·ªùi ti·∫øt n√≥ng, c·∫ßn trang ph·ª•c tho√°ng m√°t';
                }

                if (isRaining) {
                    suggestion.accessories.push('√Åo m∆∞a', '√î');
                    suggestion.shoes = 'Gi√†y ch·ªëng n∆∞·ªõc ho·∫∑c ≈©ng';
                    suggestion.reason += '. C√≥ m∆∞a n√™n c·∫ßn ƒë·ªì ch·ªëng th·∫•m.';
                }

                return suggestion;
            }

            loadWardrobe() {
                const saved = localStorage.getItem('personalWardrobe');
                return saved ? JSON.parse(saved) : this.getDefaultWardrobe();
            }

            getAvailableClothes() {
                return this.personalWardrobe.map(item => 
                    `- ${item.type}: ${item.name} (${item.color}, ${item.material || 'kh√¥ng r√µ ch·∫•t li·ªáu'})`
                ).join('\n');
            }

            getDefaultWardrobe() {
                return [
                    { type: '√Åo', name: '√Åo s∆° mi tr·∫Øng', color: 'Tr·∫Øng', material: 'Cotton' },
                    { type: '√Åo', name: '√Åo thun ƒëen', color: 'ƒêen', material: 'Cotton' },
                    { type: '√Åo', name: '√Åo hoodie x√°m', color: 'X√°m', material: 'N·ªâ' },
                    { type: '√Åo', name: '√Åo len c·ªï l·ªç', color: 'Beige', material: 'Len' },
                    { type: 'Qu·∫ßn', name: 'Qu·∫ßn jeans xanh', color: 'Xanh denim', material: 'Denim' },
                    { type: 'Qu·∫ßn', name: 'Qu·∫ßn √¢u ƒëen', color: 'ƒêen', material: 'Polyester' },
                    { type: 'Gi√†y', name: 'Sneaker tr·∫Øng', color: 'Tr·∫Øng', material: 'Da t·ªïng h·ª£p' },
                    { type: 'Gi√†y', name: 'Gi√†y da n√¢u', color: 'N√¢u', material: 'Da th·∫≠t' },
                    { type: 'Ph·ª• ki·ªán', name: 'KhƒÉn qu√†ng c·ªï', color: 'ƒêa m√†u', material: 'Len' }
                ];
            }

            getFallbackWeather() {
                return {
                    temperature: 25,
                    condition: 'Nhi·ªÅu m√¢y',
                    humidity: 75,
                    windSpeed: 10,
                    feelsLike: 23,
                    uvIndex: 3,
                    visibility: 8,
                    icon: '//cdn.weatherapi.com/weather/64x64/day/119.png',
                    isDay: 1,
                    location: 'H√† N·ªôi, Vietnam'
                };
            }

            parseAISuggestion(aiText, weather) {
                try {
                    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                } catch (error) {
                    console.error('Kh√¥ng th·ªÉ parse AI response:', error);
                }
                
                return this.getRuleBasedSuggestion(weather, 'casual');
            }

            getCurrentWeatherInfo() {
                if (this.lastWeather) {
                    return `${this.lastWeather.location}: ${this.lastWeather.temperature}¬∞C, ${this.lastWeather.condition}`;
                }
                
                const now = new Date();
                const month = now.getMonth() + 1;
                const hour = now.getHours();
                
                let season = 'xu√¢n';
                if (month >= 6 && month <= 8) season = 'h√®';
                else if (month >= 9 && month <= 11) season = 'thu';
                else if (month >= 12 || month <= 2) season = 'ƒë√¥ng';
                
                let timeOfDay = 's√°ng';
                if (hour >= 12 && hour < 18) timeOfDay = 'chi·ªÅu';
                else if (hour >= 18) timeOfDay = 't·ªëi';
                
                return `M√πa ${season}, ${timeOfDay}, nhi·ªát ƒë·ªô kho·∫£ng 25-30¬∞C`;
            }
        }

        /**
         * X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ AI v√† t·∫°o outfit
         */
        function processAIResponse(aiResponse, userMessage) {
            // T√¨m c√°c m√≥n ƒë·ªì trong ph·∫£n h·ªìi
            const clothingItems = extractClothingItems(aiResponse);
            
            let outfit = null;
            if (clothingItems.length >= 3) {
                outfit = {
                    title: generateOutfitTitle(userMessage),
                    items: clothingItems,
                    weather: getCurrentWeatherInfo(),
                    icon: getOutfitIcon(userMessage)
                };
            }
            
            return {
                message: aiResponse,
                outfit: outfit
            };
        }

        /**
         * Tr√≠ch xu·∫•t c√°c m√≥n ƒë·ªì t·ª´ ph·∫£n h·ªìi AI
         */
        function extractClothingItems(text) {
            const clothingKeywords = [
                '√°o s∆° mi', '√°o thun', '√°o kho√°c', '√°o len', '√°o blazer',
                'qu·∫ßn jeans', 'qu·∫ßn √¢u', 'qu·∫ßn short', 'ch√¢n v√°y', 'v√°y',
                'gi√†y sneaker', 'gi√†y cao g√≥t', 'gi√†y l∆∞·ªùi', 'gi√†y th·ªÉ thao',
                't√∫i x√°ch', 'ph·ª• ki·ªán', 'ƒë√¥ng h·ªì', 'k√≠nh m√°t'
            ];
            
            const foundItems = [];
            const lowerText = text.toLowerCase();
            
            clothingKeywords.forEach(item => {
                if (lowerText.includes(item) && !foundItems.includes(item)) {
                    foundItems.push(item);
                }
            });
            
            return foundItems.slice(0, 5); // T·ªëi ƒëa 5 m√≥n
        }

        /**
         * T·∫°o ti√™u ƒë·ªÅ outfit
         */
        function generateOutfitTitle(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('ƒëi l√†m') || lowerMessage.includes('c√¥ng s·ªü')) return 'Trang ph·ª•c c√¥ng s·ªü';
            if (lowerMessage.includes('h·∫πn h√≤') || lowerMessage.includes('date')) return 'Trang ph·ª•c h·∫πn h√≤';
            if (lowerMessage.includes('d·∫°o ph·ªë') || lowerMessage.includes('cu·ªëi tu·∫ßn')) return 'Trang ph·ª•c d·∫°o ph·ªë';
            if (lowerMessage.includes('ti·ªác') || lowerMessage.includes('party')) return 'Trang ph·ª•c d·ª± ti·ªác';
            if (lowerMessage.includes('th·ªÉ thao') || lowerMessage.includes('gym')) return 'Trang ph·ª•c th·ªÉ thao';
            
            return 'G·ª£i √Ω trang ph·ª•c';
        }

        /**
         * L·∫•y icon cho outfit
         */
        function getOutfitIcon(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('ƒëi l√†m')) return 'ri-briefcase-line';
            if (lowerMessage.includes('h·∫πn h√≤')) return 'ri-heart-line';
            if (lowerMessage.includes('d·∫°o ph·ªë')) return 'ri-walk-line';
            if (lowerMessage.includes('ti·ªác')) return 'ri-goblet-line';
            if (lowerMessage.includes('th·ªÉ thao')) return 'ri-run-line';
            
            return 'ri-lightbulb-flash-line';
        }

        /**
         * Debug function - ki·ªÉm tra API keys v√† k·∫øt n·ªëi
         */
        async function debugAPIConnection() {
            console.log('=== DEBUG API CONNECTION ===');
            console.log('Weather API Key:', WEATHER_API_KEY ? 'C√≥' : 'Kh√¥ng c√≥');
            console.log('Gemini API Key:', GEMINI_API_KEY ? 'C√≥' : 'Kh√¥ng c√≥');
            
            // Test Weather API
            try {
                const weatherResponse = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=Hanoi&lang=vi`);
                console.log('Weather API Status:', weatherResponse.status);
                if (weatherResponse.ok) {
                    const weatherData = await weatherResponse.json();
                    console.log('Weather Data:', weatherData.current.temp_c + '¬∞C', weatherData.current.condition.text);
                } else {
                    console.error('Weather API Error:', await weatherResponse.text());
                }
            } catch (error) {
                console.error('Weather API Connection Error:', error);
            }
            
            // Test Gemini API
            try {
                const geminiResponse = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'Hello, test connection' }] }]
                    })
                });
                console.log('Gemini API Status:', geminiResponse.status);
                if (!geminiResponse.ok) {
                    const errorData = await geminiResponse.json();
                    console.error('Gemini API Error:', errorData);
                }
            } catch (error) {
                console.error('Gemini API Connection Error:', error);
            }
            console.log('=== END DEBUG ===');
        }

        // Ch·∫°y khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', async () => {
            feather.replace();
            
            // Debug API connection (ch·ªâ trong development)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                await debugAPIConnection();
            }
            
            // Kh·ªüi t·∫°o Weather AI
            try {
                weatherAI = new WeatherOutfitAI();
                console.log('WeatherAI ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o WeatherAI:', error);
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o ch√†o m·ª´ng
            addMessage('Ch√†o b·∫°n! T√¥i l√† LookAI, tr·ª£ l√Ω th·ªùi trang AI c·ªßa b·∫°n. üëó\n\nT√¥i c√≥ th·ªÉ gi√∫p b·∫°n:\n‚Ä¢ G·ª£i √Ω trang ph·ª•c theo th·ªùi ti·∫øt\n‚Ä¢ Ph·ªëi ƒë·ªì cho c√°c ho√†n c·∫£nh kh√°c nhau\n‚Ä¢ ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn c√°c trang kh√°c', false);
            
            // L·∫•y th·ªùi ti·∫øt sau 2 gi√¢y
            setTimeout(async () => {
                if (weatherAI) {
                    try {
                        const weather = await weatherAI.getRealWeather('Hanoi');
                        addMessage(`üå§Ô∏è **C·∫≠p nh·∫≠t th·ªùi ti·∫øt:** H√¥m nay ·ªü ${weather.location} l√† ${weather.temperature}¬∞C, ${weather.condition}. T√¥i s·∫µn s√†ng gi√∫p b·∫°n ch·ªçn trang ph·ª•c ph√π h·ª£p!`, false);
                    } catch (error) {
                        console.log('Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªùi ti·∫øt:', error.message);
                        addMessage('üå§Ô∏è Kh√¥ng th·ªÉ l·∫•y th√¥ng tin th·ªùi ti·∫øt hi·ªán t·∫°i, nh∆∞ng t√¥i v·∫´n c√≥ th·ªÉ gi√∫p b·∫°n g·ª£i √Ω trang ph·ª•c!', false);
                    }
                }
            }, 2000);
        });
        // --- K·∫æT TH√öC C·∫¨P NH·∫¨T ---
    </script>
</body>
</html>