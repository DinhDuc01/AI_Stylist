<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Smart Weather Outfit - AI G·ª£i √ù Th√¥ng Minh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/remixicon.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/style.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        .api-setup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .weather-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 20px;
            color: white;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(116, 185, 255, 0.3);
        }
        .outfit-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .outfit-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .wardrobe-manager {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="bg-primary text-white py-4">
        <div class="container">
            <h1 class="mb-0">
                <i class="ri-robot-line me-2"></i>
                Smart Weather Outfit - AI G·ª£i √ù Th√¥ng Minh
            </h1>
            <p class="mb-0">T√≠ch h·ª£p API th·ªùi ti·∫øt th·ª±c + AI g·ª£i √Ω t·ª´ t·ªß ƒë·ªì c√° nh√¢n</p>
        </div>
    </header>

    <div class="container mt-4">
        <!-- API Setup Guide -->
        
        </div>

        <!-- Location & Activity Selector -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow rounded">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="mb-2">
                                    <i class="ri-map-pin-line text-primary me-2"></i>
                                    V·ªã Tr√≠
                                </h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cityInput" value="Hanoi" placeholder="Nh·∫≠p t√™n th√†nh ph·ªë...">
                                    <button class="btn btn-primary" onclick="updateSmartWeather()">
                                        <i class="ri-search-line"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-2">Ho·∫°t ƒë·ªông:</h6>
                                <select class="form-select" id="activitySelect">
                                    <option value="work">ƒêi l√†m</option>
                                    <option value="casual">D·∫°o ph·ªë</option>
                                    <option value="sport">Th·ªÉ thao</option>
                                    <option value="date">H·∫πn h√≤</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <h6 class="mb-2">Ch·∫ø ƒë·ªô AI:</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="aiModeSwitch" checked>
                                    <label class="form-check-label" for="aiModeSwitch">
                                        S·ª≠ d·ª•ng AI th√¥ng minh
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather & Outfit Display -->
        <div class="row mt-4">
            <!-- Current Weather -->
            <div class="col-lg-4">
                <div class="weather-card" id="weatherCard">
                    <div class="weather-icon" id="weatherIconContainer">
                        <i class="ri-sun-line" style="font-size: 4rem;"></i>
                    </div>
                    <div class="temperature" id="temperature" style="font-size: 3rem; font-weight: bold;">--¬∞C</div>
                    <h5 id="weatherDescription">ƒêang t·∫£i...</h5>
                    <p id="location">--</p>
                    
                    <div class="row mt-3">
                        <div class="col-4 text-center">
                            <i class="ri-drop-line"></i>
                            <div><small>ƒê·ªô ·∫©m</small></div>
                            <div id="humidity">--%</div>
                        </div>
                        <div class="col-4 text-center">
                            <i class="ri-windy-line"></i>
                            <div><small>Gi√≥</small></div>
                            <div id="windSpeed">-- km/h</div>
                        </div>
                        <div class="col-4 text-center">
                            <i class="ri-eye-line"></i>
                            <div><small>T·∫ßm nh√¨n</small></div>
                            <div id="visibility">-- km</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Outfit Suggestion -->
            <div class="col-lg-8">
                <div class="card border-0 shadow rounded">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="ri-robot-line text-primary me-2"></i>
                                G·ª£i √ù AI T·ª´ T·ªß ƒê·ªì
                            </h5>
                            <span class="ai-badge" id="aiBadge">AI Powered</span>
                        </div>
                        
                        <div id="outfitSuggestion">
                            <div class="text-center py-4">
                                <i class="ri-loader-4-line" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                                <p class="mt-2">ƒêang ph√¢n t√≠ch th·ªùi ti·∫øt v√† t·ªß ƒë·ªì...</p>
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <button class="btn btn-primary me-2" onclick="applyOutfit()">
                                <i class="ri-check-line me-1"></i>√Åp d·ª•ng outfit
                            </button>
                            <button class="btn btn-outline-primary me-2" onclick="getNewSuggestion()">
                                <i class="ri-refresh-line me-1"></i>G·ª£i √Ω kh√°c
                            </button>
                            <button class="btn btn-outline-success" onclick="rateSuggestion()">
                                <i class="ri-star-line me-1"></i>ƒê√°nh gi√°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Wardrobe Manager -->
        <div class="wardrobe-manager">
            <h5 class="mb-3">
                <i class="ri-shirt-line text-primary me-2"></i>
                Qu·∫£n L√Ω T·ªß ƒê·ªì C√° Nh√¢n
            </h5>
            
            <div class="row">
                <div class="col-md-8">
                    <div id="wardrobeList">
                        <!-- Danh s√°ch qu·∫ßn √°o s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6>Th√™m Qu·∫ßn √Åo M·ªõi</h6>
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="newItemType">
                                    <option value="√Åo">√Åo</option>
                                    <option value="Qu·∫ßn">Qu·∫ßn</option>
                                    <option value="V√°y">V√°y</option>
                                    <option value="Gi√†y">Gi√†y</option>
                                    <option value="Ph·ª• ki·ªán">Ph·ª• ki·ªán</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="newItemName" placeholder="T√™n m√≥n ƒë·ªì...">
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="newItemColor" placeholder="M√†u s·∫Øc...">
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="newItemMaterial" placeholder="Ch·∫•t li·ªáu...">
                            </div>
                            <button class="btn btn-sm btn-primary w-100" onclick="addNewItem()">
                                <i class="ri-add-line me-1"></i>Th√™m
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Status -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6>Tr·∫°ng Th√°i API</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="status-dot bg-danger me-2" id="weatherApiStatus" style="width: 10px; height: 10px; border-radius: 50%;"></div>
                                    <span>Weather API: <span id="weatherApiText">Ch∆∞a k·∫øt n·ªëi</span></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="status-dot bg-danger me-2" id="aiApiStatus" style="width: 10px; height: 10px; border-radius: 50%;"></div>
                                    <span>AI API: <span id="aiApiText">Ch∆∞a k·∫øt n·ªëi</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API Keys
        const WEATHER_API_KEY = 'd1ca006774aa4d9491d21940250611';
        const GEMINI_API_KEY = 'AIzaSyBYgj63cniNH6OyRmGifLNo7peqgU_L6k8';
        
        let currentSuggestion = null;
        let personalWardrobe = getDefaultWardrobe();

        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadWardrobe();
            updateSmartWeather();
            
            // Auto refresh m·ªói 10 ph√∫t
            setInterval(updateSmartWeather, 10 * 60 * 1000);
        });

        // C·∫≠p nh·∫≠t th·ªùi ti·∫øt v√† g·ª£i √Ω th√¥ng minh
        async function updateSmartWeather() {
            const city = document.getElementById('cityInput').value || 'Hanoi';
            const activity = document.getElementById('activitySelect').value;
            const useAI = document.getElementById('aiModeSwitch').checked;
            
            // Hi·ªÉn th·ªã loading
            document.getElementById('weatherCard').classList.add('loading');
            document.getElementById('outfitSuggestion').innerHTML = `
                <div class="text-center py-4">
                    <i class="ri-loader-4-line" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p class="mt-2">ƒêang ${useAI ? 'ph√¢n t√≠ch AI' : 'x·ª≠ l√Ω'}...</p>
                </div>
            `;

            try {
                // 1. L·∫•y th·ªùi ti·∫øt th·ª±c
                const weather = await getRealWeather(city);
                updateWeatherUI(weather);
                updateApiStatus('weather', true);
                
                // 2. L·∫•y g·ª£i √Ω outfit
                let suggestion;
                if (useAI) {
                    try {
                        suggestion = await getAIOutfitSuggestion(weather, activity);
                        updateApiStatus('ai', true);
                        document.getElementById('aiBadge').textContent = 'AI Powered';
                    } catch (error) {
                        console.log('AI API kh√¥ng kh·∫£ d·ª•ng, d√πng rules fallback');
                        suggestion = getRuleBasedSuggestion(weather, activity);
                        updateApiStatus('ai', false);
                        document.getElementById('aiBadge').textContent = 'Rules Based';
                    }
                } else {
                    suggestion = getRuleBasedSuggestion(weather, activity);
                    document.getElementById('aiBadge').textContent = 'Rules Based';
                }
                
                currentSuggestion = suggestion;
                updateOutfitUI(suggestion);
                
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                updateApiStatus('weather', false);
                showError('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.');
            } finally {
                document.getElementById('weatherCard').classList.remove('loading');
            }
        }

        // L·∫•y th·ªùi ti·∫øt th·ª±c
        async function getRealWeather(city = 'Hanoi') {
            const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${city}&lang=vi`);
            
            if (!response.ok) {
                throw new Error('Weather API error');
            }
            
            const data = await response.json();
            return {
                temperature: data.current.temp_c,
                condition: data.current.condition.text,
                humidity: data.current.humidity,
                windSpeed: data.current.wind_kph,
                feelsLike: data.current.feelslike_c,
                visibility: data.current.vis_km,
                icon: data.current.condition.icon,
                location: `${data.location.name}, ${data.location.country}`
            };
        }

        // AI g·ª£i √Ω outfit
        async function getAIOutfitSuggestion(weather, activity) {
            const prompt = `Th·ªùi ti·∫øt hi·ªán t·∫°i: ${weather.temperature}¬∞C, ${weather.condition}. 
Ho·∫°t ƒë·ªông: ${activity}. 
H√£y g·ª£i √Ω outfit ph√π h·ª£p b·∫±ng ti·∫øng Vi·ªát, ng·∫Øn g·ªçn.`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 300 }
                })
            });

            if (!response.ok) {
                throw new Error('Gemini API error');
            }

            const data = await response.json();
            const aiText = data.candidates[0].content.parts[0].text;
            
            return {
                top: '√Åo ƒë∆∞·ª£c AI g·ª£i √Ω',
                bottom: 'Qu·∫ßn ƒë∆∞·ª£c AI g·ª£i √Ω', 
                shoes: 'Gi√†y ƒë∆∞·ª£c AI g·ª£i √Ω',
                accessories: [],
                reason: aiText,
                comfort_score: 9
            };
        }

        // Rules-based suggestion
        function getRuleBasedSuggestion(weather, activity) {
            const temp = weather.temperature;
            let suggestion = {
                top: '',
                bottom: '',
                shoes: '',
                accessories: [],
                reason: '',
                comfort_score: 8
            };

            if (temp < 15) {
                suggestion.top = '√Åo kho√°c d√†y, √°o len';
                suggestion.bottom = 'Qu·∫ßn jeans d√†y';
                suggestion.shoes = 'Gi√†y b·ªët';
                suggestion.accessories = ['KhƒÉn qu√†ng c·ªï', 'M≈© len'];
                suggestion.reason = 'Th·ªùi ti·∫øt l·∫°nh, c·∫ßn gi·ªØ ·∫•m';
            } else if (temp < 25) {
                suggestion.top = '√Åo hoodie ho·∫∑c cardigan';
                suggestion.bottom = 'Qu·∫ßn jeans';
                suggestion.shoes = 'Sneaker';
                suggestion.accessories = ['√Åo kho√°c nh·∫π'];
                suggestion.reason = 'Th·ªùi ti·∫øt m√°t m·∫ª, tho·∫£i m√°i';
            } else {
                suggestion.top = '√Åo thun cotton';
                suggestion.bottom = 'Qu·∫ßn short';
                suggestion.shoes = 'Sandal';
                suggestion.accessories = ['M≈© ch·ªëng n·∫Øng'];
                suggestion.reason = 'Th·ªùi ti·∫øt n√≥ng, c·∫ßn tho√°ng m√°t';
            }

            if (weather.condition.toLowerCase().includes('m∆∞a')) {
                suggestion.accessories.push('√Åo m∆∞a', '√î');
                suggestion.reason += '. C√≥ m∆∞a n√™n c·∫ßn ƒë·ªì ch·ªëng th·∫•m.';
            }

            return suggestion;
        }

        // C·∫≠p nh·∫≠t UI th·ªùi ti·∫øt
        function updateWeatherUI(weather) {
            document.getElementById('temperature').textContent = `${weather.temperature}¬∞C`;
            document.getElementById('weatherDescription').textContent = weather.condition;
            document.getElementById('location').textContent = weather.location;
            document.getElementById('humidity').textContent = `${weather.humidity}%`;
            document.getElementById('windSpeed').textContent = `${weather.windSpeed} km/h`;
            document.getElementById('visibility').textContent = `${weather.visibility} km`;
            
            // C·∫≠p nh·∫≠t icon
            const iconContainer = document.getElementById('weatherIconContainer');
            if (weather.icon) {
                iconContainer.innerHTML = `<img src="https:${weather.icon}" alt="${weather.condition}" style="width: 64px; height: 64px;">`;
            }
        }

        // C·∫≠p nh·∫≠t UI g·ª£i √Ω outfit
        function updateOutfitUI(suggestion) {
            const container = document.getElementById('outfitSuggestion');
            
            container.innerHTML = `
                <div class="outfit-item">
                    <i class="ri-shirt-line text-primary me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${suggestion.top}</h6>
                        <small class="text-muted">√Åo ph√π h·ª£p v·ªõi th·ªùi ti·∫øt</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">Ph√π h·ª£p ${suggestion.comfort_score}/10</span>
                    </div>
                </div>
                
                <div class="outfit-item">
                    <i class="ri-user-line text-primary me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${suggestion.bottom}</h6>
                        <small class="text-muted">Qu·∫ßn/v√°y ph√π h·ª£p</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">Tho·∫£i m√°i</span>
                    </div>
                </div>
                
                <div class="outfit-item">
                    <i class="ri-footprint-line text-primary me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${suggestion.shoes}</h6>
                        <small class="text-muted">Gi√†y d√©p ph√π h·ª£p</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info">Ph√π h·ª£p</span>
                    </div>
                </div>
                
                ${suggestion.accessories && suggestion.accessories.length > 0 ? `
                <div class="outfit-item">
                    <i class="ri-handbag-line text-primary me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Ph·ª• ki·ªán</h6>
                        <small class="text-muted">${suggestion.accessories.join(', ')}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-warning">Khuy√™n d√πng</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-3 p-3 bg-light rounded">
                    <small><strong>üí° L√Ω do:</strong> ${suggestion.reason}</small>
                </div>
            `;
        }

        // Qu·∫£n l√Ω t·ªß ƒë·ªì
        function loadWardrobe() {
            const container = document.getElementById('wardrobeList');
            
            container.innerHTML = personalWardrobe.map(item => `
                <div class="d-flex align-items-center justify-content-between p-2 border-bottom">
                    <div>
                        <strong>${item.type}:</strong> ${item.name} 
                        <span class="text-muted">(${item.color})</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id || Date.now()})">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            `).join('');
        }

        function addNewItem() {
            const type = document.getElementById('newItemType').value;
            const name = document.getElementById('newItemName').value;
            const color = document.getElementById('newItemColor').value;
            const material = document.getElementById('newItemMaterial').value;
            
            if (!name || !color) {
                alert('Vui l√≤ng nh·∫≠p t√™n v√† m√†u s·∫Øc!');
                return;
            }
            
            personalWardrobe.push({
                id: Date.now(),
                type, name, color, material,
                addedDate: new Date().toISOString()
            });
            
            localStorage.setItem('personalWardrobe', JSON.stringify(personalWardrobe));
            loadWardrobe();
            
            // Clear form
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemColor').value = '';
            document.getElementById('newItemMaterial').value = '';
        }

        function getDefaultWardrobe() {
            const saved = localStorage.getItem('personalWardrobe');
            if (saved) return JSON.parse(saved);
            
            return [
                { id: 1, type: '√Åo', name: '√Åo s∆° mi tr·∫Øng', color: 'Tr·∫Øng', material: 'Cotton' },
                { id: 2, type: '√Åo', name: '√Åo thun ƒëen', color: 'ƒêen', material: 'Cotton' },
                { id: 3, type: '√Åo', name: '√Åo hoodie x√°m', color: 'X√°m', material: 'N·ªâ' },
                { id: 4, type: 'Qu·∫ßn', name: 'Qu·∫ßn jeans xanh', color: 'Xanh denim', material: 'Denim' },
                { id: 5, type: 'Qu·∫ßn', name: 'Qu·∫ßn √¢u ƒëen', color: 'ƒêen', material: 'Polyester' },
                { id: 6, type: 'Gi√†y', name: 'Sneaker tr·∫Øng', color: 'Tr·∫Øng', material: 'Da t·ªïng h·ª£p' },
                { id: 7, type: 'Gi√†y', name: 'Gi√†y da n√¢u', color: 'N√¢u', material: 'Da th·∫≠t' }
            ];
        }

        // C√°c h√†m ti·ªán √≠ch
        function updateApiStatus(type, isConnected) {
            const statusDot = document.getElementById(`${type}ApiStatus`);
            const statusText = document.getElementById(`${type}ApiText`);
            
            if (isConnected) {
                statusDot.className = 'status-dot bg-success me-2';
                statusText.textContent = 'K·∫øt n·ªëi th√†nh c√¥ng';
            } else {
                statusDot.className = 'status-dot bg-danger me-2';
                statusText.textContent = 'L·ªói k·∫øt n·ªëi';
            }
        }

        function showError(message) {
            document.getElementById('outfitSuggestion').innerHTML = `
                <div class="alert alert-warning">
                    <i class="ri-error-warning-line me-2"></i>
                    ${message}
                </div>
            `;
        }

        function applyOutfit() {
            if (currentSuggestion) {
                alert('‚úÖ ƒê√£ √°p d·ª•ng g·ª£i √Ω! Outfit ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠.');
                // C√≥ th·ªÉ l∆∞u v√†o calendar ho·∫∑c history
            }
        }

        function getNewSuggestion() {
            updateSmartWeather();
        }

        function rateSuggestion() {
            if (!currentSuggestion) return;
            
            const rating = prompt('ƒê√°nh gi√° g·ª£i √Ω n√†y (1-5 sao):');
            if (rating && rating >= 1 && rating <= 5) {
                // L∆∞u feedback
                const feedback = {
                    timestamp: Date.now(),
                    suggestion: currentSuggestion,
                    rating: parseInt(rating)
                };
                
                let feedbackHistory = JSON.parse(localStorage.getItem('outfitFeedback') || '[]');
                feedbackHistory.push(feedback);
                localStorage.setItem('outfitFeedback', JSON.stringify(feedbackHistory));
                
                alert(`C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√° ${rating} sao! AI s·∫Ω h·ªçc h·ªèi ƒë·ªÉ c·∫£i thi·ªán.`);
            }
        }

        // CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
